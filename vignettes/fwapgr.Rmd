---
title: "Using fwapgr"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using fwapgr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(magrittr)
```

```{r, include=FALSE}
library(httptest)
set_requester(function (request) {
    gsub_request(request, "https://www.hillcrestgeo.ca/fwa/v1/", "api/")
})
start_vignette("fwapgr")
```
---
output: github_document
---

The `fwapgr` package is used to retrieve data from the BC Freshwater Atlas. In this article, we'll get stream, lake, and watershed data to create a map of the Yakoun River watershed in Haida Gwaii, BC. 

We can get started by looking at all available layers and which columns are in a specific layer.
```{r}
fwapgr::fwa_list_layers()
```

```{r}
fwapgr::fwa_list_columns('fwa_stream_networks_sp')
```

`fwa_feature` is the workhorse function of `fwapgr`, allowing us to retrieve data from any available layer in the database and filter using a SQL WHERE statement. To get a linestring feature of the Yakoun river, we could use the 'fwa_stream_networks_sp' or 'fwa_named_streams' layers and filter by `gnis_name` column. 

```{r, results='hide'}
fwapgr::fwa_feature("fwa_stream_networks_sp", filter = "gnis_name = 'Yakoun River'", columns = "blue_line_key")
```

However, for this specific case we can use the convenience function `fwa_gnis_streams` and ensure that we have a valid 'gnis_name' by using `fwa_search_gnis_streams`. We use the `columns` argument to get the `blue_line_key` column along with the geometry. 
```{r}
print(fwapgr::fwa_search_gnis_streams("yakoun"))
yakoun <- fwapgr::fwa_gnis_streams("Yakoun River", columns = "blue_line_key")
yakoun
```

Next let's get the Yakoun River watershed with `fwa_watershed`, which requires a `blue_line_key`.
```{r}
blue_line_key <- unique(yakoun$blue_line_key)
wshed <- fwapgr::fwa_watershed(blue_line_key)
```

We can use the 'fwa_lakes_poly' layer to get lake data and use the `bounds` argument to only retrieve lakes within the bounding box of the watershed. 
```{r}
bbox <- sf::st_bbox(wshed)
lakes <- fwapgr::fwa_feature("fwa_lakes_poly", bounds = bbox)
```

Finally, lets get all streams within the watershed bounds that have a 'stream_order' less than 3.
```{r warning=FALSE, message=FALSE}
streams <- fwapgr::fwa_feature("fwa_stream_networks_sp",
                               filter = "stream_order > 1",
                               bounds = bbox)
```

To make the map look a little prettier, we can clip the stream and lake layers to the watershed polygon.
```{r warning=FALSE, message=FALSE}
streams <- sf::st_intersection(streams, wshed)
lakes <- sf::st_intersection(lakes, wshed)
```


```{r dpi=300, fig.width=7, fig.height=7}
ggplot2::ggplot(data = yakoun) +
  ggplot2::geom_sf(data = wshed, lwd = 0.15) +
  ggplot2::geom_sf(data = streams, lwd = 0.15, colour = 'steelblue') +
  ggplot2::geom_sf(lwd = 0.3) +
  ggplot2::geom_sf(data = lakes, fill = "steelblue", lwd = 0.1)
```
```{r, include=FALSE}
end_vignette()
```
