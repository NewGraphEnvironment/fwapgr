---
title: "Using fwapgr"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using fwapgr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(magrittr)
```

```{r, include=FALSE}
library(httptest)
set_requester(function (request) {
    gsub_request(request, "https://www.hillcrestgeo.ca/fwapg/", "api/")
})
start_vignette("fwapgr")
```
---
output: github_document
---

`fwapgr` is an R client for the [BC Freshwater Atlas PostgreSQL](https://github.com/smnorris/fwapg) database [web API](https://www.hillcrestgeo.ca/fwapg/index.html). It gets and filters data from the BC Freshwater Atlas into R!  

In this article, we will create a basic map of the Yakoun River watershed in Haida Gwaii, BC, primarily using `fwapgr`'s workhorse function: `fwa_collection`. We can get started by looking at all available tables and which columns are in a specific table.
```{r}
fwapgr::fwa_list_tables()
```

```{r}
fwapgr::fwa_list_columns('fwa_stream_networks_sp')
```

`fwa_collection` allows us to retrieve data from any available table in the database and filter for desired values on any column. To get a linestring feature of the Yakoun river, we could use the 'fwa_stream_networks_sp' or 'fwa_named_streams' table and filter by `gnis_name` column. 

```{r, results='hide'}
fwapgr::fwa_collection("fwa_stream_networks_sp", filter = list(gnis_name = "Yakoun River"))
```

There are a few convenience functions available for occasions when you are looking for a gnis_name. We can search for a valid 'gnis_name' using `fwa_search_gnis_streams` and pipe that into `fwa_stream_gnis`, which is just a wrapper on `fwa_collection(table = "fwa_stream_networks_sp", filter = list(gnis_name = ??))`.
```{r}
yakoun <- fwapgr::fwa_search_gnis_streams("yakoun") %>%
  print() %>%
  fwapgr::fwa_stream_gnis()
  
yakoun[1:2]
```

Let's also get the Yakoun River watershed using the "fwa_named_watersheds_poly" table.
```{r}
wshed <- fwapgr::fwa_collection(table = "fwa_named_watersheds_poly", filter = list(gnis_name = "Yakoun River"))
```

Next, let's get all the lakes that are within the Yakoun river watershed. We can use the `bbox` argument for this and the 'fwa_lakes_poly' table. 
```{r}
bbox <- sf::st_bbox(wshed)
lakes <- fwapgr::fwa_collection("fwa_lakes_poly", bbox = bbox)
```

Finally, lets get all streams within the watershed bounds with stream_order greater than 1. order streams.
```{r warning=FALSE, message=FALSE}
streams <- fwapgr::fwa_collection("fwa_stream_networks_sp", bbox = bbox)
streams <- streams[streams$stream_order > 2,]
```

To make the map look a little prettier, we can clip the stream and lake layers to the watershed polygon.
```{r warning=FALSE, message=FALSE}
streams <- sf::st_intersection(streams, wshed)
lakes <- sf::st_intersection(lakes, wshed)
```


```{r dpi=300, fig.width=7, fig.height=7}
ggplot2::ggplot(data = yakoun) +
  ggplot2::geom_sf(data = wshed, lwd = 0.15) +
  ggplot2::geom_sf(data = streams, lwd = 0.15, colour = 'steelblue') +
  ggplot2::geom_sf(lwd = 0.3) +
  ggplot2::geom_sf(data = lakes, fill = "steelblue", lwd = 0.1)
```
```{r, include=FALSE}
end_vignette()
```
